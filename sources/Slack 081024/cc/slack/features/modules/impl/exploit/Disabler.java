// Slack Client (discord.gg/slackclient)

package cc.slack.features.modules.impl.exploit;

import cc.slack.events.impl.player.AttackEvent;
import cc.slack.features.modules.impl.exploit.disablers.others.HypixelDisabler;
import cc.slack.features.modules.impl.exploit.disablers.verus.VerusCombatDisabler;
import cc.slack.start.Slack;
import cc.slack.events.impl.network.PacketEvent;
import cc.slack.events.impl.player.MoveEvent;
import cc.slack.events.impl.player.UpdateEvent;
import cc.slack.events.impl.player.WorldEvent;
import cc.slack.features.modules.api.settings.Value;
import cc.slack.features.modules.api.settings.impl.BooleanValue;
import cc.slack.features.modules.api.settings.impl.ModeValue;
import cc.slack.features.modules.impl.exploit.disablers.IDisabler;
import cc.slack.features.modules.impl.exploit.disablers.others.NoneDisabler;
import cc.slack.features.modules.impl.exploit.disablers.others.RidingDisabler;
import cc.slack.features.modules.impl.exploit.disablers.verus.OldVerusCombatDisabler;
import cc.slack.features.modules.api.Category;
import cc.slack.features.modules.api.Module;
import cc.slack.features.modules.api.ModuleInfo;
import cc.slack.features.modules.impl.exploit.disablers.vulcan.VulcanReachDisabler;
import cc.slack.features.modules.impl.world.Scaffold;
import cc.slack.utils.network.PacketUtil;
import io.github.nevalackin.radbus.Listen;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.network.play.client.*;
import net.minecraft.network.Packet;
import net.minecraft.util.BlockPos;
import net.minecraft.util.EnumFacing;

@ModuleInfo(
        name = "Disabler",
        category = Category.EXPLOIT
)
public class Disabler extends Module {

    private final ModeValue<IDisabler> mode = new ModeValue<>("Mode",new IDisabler[]{
            // None
            new NoneDisabler(),

            // Hypixel
            new HypixelDisabler(),

            // Verus
            new VerusCombatDisabler(),
            new OldVerusCombatDisabler(),

            // Vulcan
            new VulcanReachDisabler(),

            // Packet edit
            new RidingDisabler()
    });

    public final BooleanValue verusonlyCombat = new BooleanValue("Verus Only Combat",true);
    private final BooleanValue verusScaffold = new BooleanValue("Verus Scaffold Check", false);
    private final BooleanValue verusOmniSprint = new BooleanValue("Verus OmniSprint Check", false);
    private final BooleanValue verusflycheck = new BooleanValue("Verus Fly Check", false);
    private final BooleanValue vulcanSprint = new BooleanValue("Vulcan Sprint Check", false);
    private final BooleanValue vulcanLimit = new BooleanValue("Vulcan Scaffold Limit Check", false);

    private final BooleanValue oldDisablers = new BooleanValue("Old Disablers", false);

    class e implements Value.VisibilityCheck {
        @Override
        public boolean check(){
            return oldDisablers.getValue();
        }
    }

    private final BooleanValue spectator = new BooleanValue("Spectator Spoof", false).require(new e());
    private final BooleanValue riding = new BooleanValue("Riding Spoof", false).require(new e());
    private final BooleanValue oldVulcanStrafe = new BooleanValue("Old Vulcan Strafe", false).require(new e());

    // Display
    private final ModeValue<String> displayMode = new ModeValue<>("Display", new String[]{"Simple", "Off"});


    private int c03Counter;
    boolean attackcheck = true;


    public Disabler() {
        super();
        addSettings(mode, verusonlyCombat,verusScaffold, verusOmniSprint, verusflycheck,vulcanSprint, vulcanLimit, oldDisablers, spectator, riding, oldVulcanStrafe, displayMode);
    }


    @Override
    public void onEnable() {
        mode.getValue().onEnable();
        if (verusOmniSprint.getValue() && mc.thePlayer.isSprinting()) {
            PacketUtil.sendNoEvent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SPRINTING));
        }
    }

    @Override
    public void onDisable() {
        mode.getValue().onDisable();
    }

    @Listen
    public void onMove(MoveEvent event) {
        mode.getValue().onMove(event);
    }

    @Listen
    public void onUpdate(UpdateEvent event) {

        // Verus Fly Check
        if (verusflycheck.getValue()) {
            EntityPlayer player = mc.thePlayer;
            if (player == null) return;

            if (attackcheck && !player.isDead) {
                BlockPos pos = player.getPosition().add(0, player.posY > 0 ? -100 : 100, 0);
                if (pos == null) return;

                PacketUtil.send(new C08PacketPlayerBlockPlacement(
                        pos,
                        1,
                        new ItemStack(Items.water_bucket),
                        0.0F,
                        0.5F + (float)Math.random() * 0.44F,
                        0.0F
                ));
            } else {
                attackcheck = true;
            }
        }

        // Vulcan Limit
        if (vulcanLimit.getValue() && Slack.getInstance().getModuleManager().getInstance(Scaffold.class).isToggle()){
            if (mc.thePlayer.ticksExisted % 20 == 0) {
                PacketUtil.sendNoEvent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SNEAKING));
                PacketUtil.sendNoEvent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SNEAKING));
            }
        }

        //  Vulcan Sprint
        if (vulcanSprint.getValue() && Slack.getInstance().getModuleManager().getInstance(Scaffold.class).isToggle()) {
            PacketUtil.sendNoEvent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SPRINTING));
            PacketUtil.sendNoEvent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SPRINTING));
        }


        mode.getValue().onUpdate(event);
    }

    @Listen
    public void onAttack(AttackEvent event) {
        attackcheck = false;
        mode.getValue().onAttack(event);
    }

    @Listen
    public void onWorld(WorldEvent event) {
        mode.getValue().onWorld(event);
    }

    @Listen
    public void onPacket(PacketEvent event) {
        final Packet packet = event.getPacket();

        if (verusOmniSprint.getValue() && packet instanceof C0BPacketEntityAction) {
            event.cancel();
        }
        if (verusScaffold.getValue() && packet instanceof C08PacketPlayerBlockPlacement) {
            ((C08PacketPlayerBlockPlacement) packet).stack = null;
        }
        if (spectator.getValue() && packet instanceof C03PacketPlayer){
            mc.getNetHandler().addToSendQueue(new C18PacketSpectate(mc.thePlayer.getUniqueID()));
        }
        if (riding.getValue() && packet instanceof C03PacketPlayer) {
            mc.getNetHandler().addToSendQueue(new C0CPacketInput(mc.thePlayer.moveStrafing, mc.thePlayer.moveForward, mc.thePlayer.movementInput.jump, mc.thePlayer.movementInput.sneak));
        }

        if (oldVulcanStrafe.getValue() && packet instanceof C03PacketPlayer) {
            c03Counter++;
            if (((C03PacketPlayer) packet).isMoving()) {
                if (c03Counter >= 6) {
                    PacketUtil.sendNoEvent(new C07PacketPlayerDigging(C07PacketPlayerDigging.Action.STOP_DESTROY_BLOCK, BlockPos.ORIGIN, EnumFacing.DOWN));
                    c03Counter = 0;
                } else if (c03Counter == 6 - 2) {
                    PacketUtil.sendNoEvent(new C07PacketPlayerDigging(C07PacketPlayerDigging.Action.START_DESTROY_BLOCK, BlockPos.ORIGIN, EnumFacing.DOWN));
                }
            }
        }
        mode.getValue().onPacket(event);
    }

    @Override
    public String getMode() {
        switch (displayMode.getValue()) {
            case "Simple":
                return mode.getValue().toString();
        }
        return null;
    }

}
