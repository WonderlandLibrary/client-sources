package me.aquavit.liquidsense.module.modules.exploit;

import me.aquavit.liquidsense.event.EventTarget;
import me.aquavit.liquidsense.event.events.KeyEvent;
import me.aquavit.liquidsense.event.events.PacketEvent;
import me.aquavit.liquidsense.event.events.ScreenEvent;
import me.aquavit.liquidsense.module.Module;
import me.aquavit.liquidsense.module.ModuleCategory;
import me.aquavit.liquidsense.module.ModuleInfo;
import net.minecraft.client.gui.inventory.GuiContainer;
import net.minecraft.client.gui.inventory.GuiInventory;
import net.minecraft.network.play.client.C0DPacketCloseWindow;
import net.minecraft.network.play.server.S2EPacketCloseWindow;
import org.lwjgl.input.Keyboard;

@ModuleInfo(name = "KeepContainer", description = "Allows you to open a formerly closed inventory container everywhere. (Press INSERT Key to open)", category = ModuleCategory.EXPLOIT)
public class KeepContainer extends Module {
    private GuiContainer container;

    @Override
    public void onDisable() {
        if(container != null)
            mc.getNetHandler().addToSendQueue(new C0DPacketCloseWindow(container.inventorySlots.windowId));

        container = null;
    }

    @EventTarget
    public void onGui(final ScreenEvent event) {
        if(event.getGuiScreen() instanceof GuiContainer && !(event.getGuiScreen() instanceof GuiInventory))
            container = (GuiContainer) event.getGuiScreen();
    }

    @EventTarget
    public void onKey(final KeyEvent event) {
        if(event.getKey() == Keyboard.KEY_INSERT) {
            if(container == null)
                return;

            mc.displayGuiScreen(container);
        }
    }

    @EventTarget
    public void onPacket(final PacketEvent event) {
        if(event.getPacket() instanceof C0DPacketCloseWindow)
            event.cancelEvent();

        if(event.getPacket() instanceof S2EPacketCloseWindow) {
            final S2EPacketCloseWindow packetCloseWindow = (S2EPacketCloseWindow) event.getPacket();

            if(container != null && container.inventorySlots != null && packetCloseWindow.windowId == container.inventorySlots.windowId)
                container = null;
        }
    }
}
